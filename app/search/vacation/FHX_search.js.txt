/**BuildTime: Thursday, December 19, 2013
 *If you found any bug, please mail to shiz@ctrip.com*/
(function(){var S={format:function(e){var t=arguments;return t.length==0?e:e.replace(/\$(\d)/g,function(e,n){return t[n]==undefined?"":t[n]})},dateDiff:function(e,t,n,r){$.type(e)!=="date"&&(e=e.toDate()),$.type(t)!=="date"&&(t=t.toDate());var i=Math.abs(e.getTime()-t.getTime());switch(n){case"S":return i;case"s":return Math.round(i/1e3);case"m":return Math.round(i/1e3/60);case"h":return Math.round(i/1e3/60/60);case"d":return Math.round(i/1e3/60/60/24);case"M":return Math.abs((e.getFullYear()-t.getFullYear())*12+(e.getMonth()-t.getMonth()));case"y":return Math.abs(e.getFullYear()-t.getFullYear());default:return null}},create:function(e){e=e.trim();var t=document.createElement("div");t.innerHTML=e;var n=t.firstChild;if(n.nodeType!=1||t.childNodes.length>2){var r=/<([\w:]+)([^\>]*)>/,i=e.match(r);if(!i)return null;var s=i[1];if(s=="tr"||s=="td"){var o=s=="tr"?"<table><tbody>"+e+"</tbody></table>":"<table><tbody><tr>"+e+"</tr></tbody></table>",u=S.create(o);return s=="tr"?u.rows[0]:u.rows[0].cells[0]}return null}return n}},Mod={showTips:function(e,t,n){return Mod.formValidator||(Mod.formValidator=$(document).regMod("validate","1.1")),typeof e.bind!="function"&&(e=$(e)),Mod.formValidator.method("show",{$obj:e,data:t,removeErrorClass:!0,hideEvent:n||"blur",isFocus:!0,isScroll:!1}),!1}};(function(exports){function t(){var e=$.fn.value;$.fn.value=function(t){var n=this,r=this[0];if(!r)return"";var i=r.getAttribute("placeholder");if(!i)return e.call(n,t);if(typeof t=="undefined")return r.value==i?"":r.value;t.trim()==""||t.trim()==i?(r.value=i,r.style.color="gray"):(r.value=t,r.style.color="")}}var e="placeholder"in document.createElement("input"),n=function(e,t){e[0].value.trim()==""&&(e[0].value=t),this.txt=e,this.msg=t,e[0].setAttribute("placeholder",t),e[0].value==t&&e.css({color:"gray"}),e.bind("focus",this.hide.bind(this)).bind("blur",this.show.bind(this))};n.prototype={show:function(){var e=this.txt;if(this.msg==e[0].value||e[0].value.trim()=="")e[0].value=this.msg,e[0].style.color="gray"},hide:function(){var e=this.txt;this.msg==e[0].value&&(e[0].value="",e[0].style.color="")}},exports.regPlaceHolder=function(r,i){if(!r)return;if(!i)return;typeof r.value!="function"&&(r=$(r));if(!r[0])return;e?r[0].placeholder=i:(new n(r,i),t())}})(Mod),function(exports){var e=function(){this._events={}};e.prototype={constructor:e,on:function(e,t){e in this._events||(this._events[e]=[]),this._events[e].push(t)},off:function(e,t){var n=this._events[e];if(!n)return;for(var r=0,i=n.length;r<i;r++)if(n[r]==t){n.splice(r,1);return}},emit:function(e){if(!this._events[e])return;var t=this._events[e],n=Array.prototype.slice.apply(arguments);n=n.slice(1);for(var r=0,i=t.length;r<i;r++)t[r].apply(this,n)}},e.extend=function(t){var n=new e;for(var r in n)n.hasOwnProperty(r)&&(t[r]=n[r]);for(var r in e.prototype){if(r==="constructor")continue;t[r]=n[r]}return t},exports.EventEmitter=e}(Mod);var e={_key:"FHXSearch",_fields:{from:{id:2,name:FHXConfig.defaultDepart,en:"shanghai",date:(new Date).addDays(2).toFormatString("yyyy-MM-dd")},to:{id:"",name:"",en:"",date:(new Date).addDays(4).toFormatString("yyyy-MM-dd")},adults:2,children:0},save:function(){var e=window.location.href.indexOf("ctrip.com")>0?"ctrip.com":"ctriptravel.com",t={expires:2,domain:e},n=this._key;cQuery.cookie.set(n,"from.id",$("#FHX_hFromID").value(),t),cQuery.cookie.set(n,"from.name",$("#FHX_txtFrom").value(),t),cQuery.cookie.set(n,"from.en",$("#FHX_hFromPY").value(),t),cQuery.cookie.set(n,"from.date",$("#FHX_txtFromDate").value(),t),cQuery.cookie.set(n,"to.id",$("#FHX_hToID").value(),t),cQuery.cookie.set(n,"to.name",$("#FHX_txtTo").value(),t),cQuery.cookie.set(n,"to.en",$("#FHX_hToPY").value(),t),cQuery.cookie.set(n,"to.date",$("#FHX_txtToDate").value(),t),cQuery.cookie.set(n,"adults",$("#FHX_AdultSelect").value(),t),cQuery.cookie.set(n,"children",$("#FHX_ChildrenSelect").value(),t)},recover:function(){this.recoverFromVacationCookie(),this.recoverFromCookie(),this._checkDates();var e=this._fields;$("#FHX_hFromID").value(e.from.id),$("#FHX_txtFrom").value(e.from.name),$("#FHX_hFromPY").value(e.from.en),$("#FHX_txtFromDate").value(e.from.date),$("#FHX_hToID").value(e.to.id),$("#FHX_txtTo").value(e.to.name),$("#FHX_hToPY").value(e.to.en),$("#FHX_txtToDate").value(e.to.date),$("#FHX_AdultSelect").value(e.adults),$("#FHX_ChildrenSelect").value(e.children),$("#FHX_divHotelQuery li[data-hotel] input").each(function(t,n){switch(n){case 0:t.value(e.to.name);break;case 1:t.value(e.to.id);break;case 2:t.value(e.to.en);break;case 3:t.value(e.from.date);break;case 4:t.value(e.to.date)}})},recoverFromCookie:function(){var e=this._key,t=this._fields,n={};for(var r in t){var i=t[r];if(typeof i=="object"){n[r]={};for(var s in i)n[r][s]=cQuery.cookie.get(e,r+"."+s)||i[s]}else n[r]=cQuery.cookie.get(e,r)||i}return this._fields=n,n},recoverFromVacationCookie:function(){var e=cQuery.cookie.get("StartCity_Pkg");if(!e)return;e=e.split("=")[1],this._fields.from.id=e,this._fields.from.name=FHXConfig.START_CITY[e]},_checkDates:function(){var e=(new Date).toFormatString("yyyy-MM-dd");this._fields.from.date<=e&&(this._fields.from.date=(new Date).addDays(2).toFormatString("yyyy-MM-dd"),this._fields.to.date=(new Date).addDays(4).toFormatString("yyyy-MM-dd"))}},t={checkAddress:function(e,t){if(t){if(!e.value().trim())return Mod.showTips(e,FHXConfig.validate[8]);if(!t.value().trim())return Mod.showTips(t,FHXConfig.validate[9]);if(e.value().trim()==t.value().trim())return Mod.showTips(t,FHXConfig.validate[13])}else if(!e.value().trim())return Mod.showTips(e,FHXConfig.validate[10]);return!0},checkDate:function(e,t,n,r){var i=e.value(),s=t.value();if(n){var o=n.value(),u=r.value();if(o=="")return Mod.showTips(n,FHXConfig.validate[2]);if(u=="")return Mod.showTips(r,FHXConfig.validate[3]);if(!o.isDate())return Mod.showTips(n,FHXConfig.validate[4]);if(!u.isDate())return Mod.showTips(r,FHXConfig.validate[4]);if(o>=u)return Mod.showTips(r,FHXConfig.validate[6]);if(S.dateDiff(o,u,"d")>28)return Mod.showTips(r,FHXConfig.validate[7]);if(o.toDate().addDays(1)<i.toDate())return Mod.showTips(n,FHXConfig.validate[11]);if(s.toDate().addDays(1)<u.toDate())return Mod.showTips(r,FHXConfig.validate[12])}else{if(i=="")return Mod.showTips(e,FHXConfig.validate[0]);if(s=="")return Mod.showTips(t,FHXConfig.validate[1]);if(!i.isDate())return Mod.showTips(e,FHXConfig.validate[4]);if(!s.isDate())return Mod.showTips(t,FHXConfig.validate[4]);if(i>=s)return Mod.showTips(t,FHXConfig.validate[5]);if(S.dateDiff(i,s,"d")>28)return Mod.showTips(t,FHXConfig.validate[7])}return!0}},n={_textboxes:[],_hotelCount:0,_hotelDateChanged:!1,_hotelCityChanged:!1,focusNext:!0,validate:function(e){var n=this;this.focusNext=!1;var r=t.checkAddress(n._textboxes[0],n._textboxes[1])&&t.checkDate(n._textboxes[2],n._textboxes[3]);if(!r)return r;var i=n._textboxes;for(var s=4;s<i.length;s+=3){r=t.checkAddress(i[s]);if(!r)return r;r=t.checkDate(n.txtFromDate,n.txtToDate,i[s+1],i[s+2]);if(!r)return r}e()},getUrl:function(){var e=document.getElementsByName("ToCities")[0].value;return this._hotelCount>1||this.hToID.value()!=e?FHXConfig.URL.FREE_COMBINE:S.format(FHXConfig.URL.SINGLE_FLT_HOTEL,"round",this.hFromPY.value(),this.hFromID.value(),this.hToPY.value(),this.hToID.value()).toLowerCase()},search:function(t){n.validate(function(){var t=n.getUrl();e.save();var r=$("#FHX_form")[0];r.action=t,r.submit()})},_splitFlightDates:function(){if(this._hotelDateChanged)return;var e=this.txtFromDate.value(),t=this.txtToDate.value();if(!e.isDate()||!t.isDate()||e>t)return;var n=[],r=S.dateDiff(e,t,"d");if(r<1)return;if(r==1)return[e,t];var i=Math.floor(r/this._hotelCount),s=r%this._hotelCount;e=e.toDate(),t=t.toDate();var o=0,u=0;for(var a=0;a<this._hotelCount;a++)u=o+i+(a<s?1:0),o==u&&o--,n.push(e.addDays(o).toFormatString("yyyy-MM-dd"),e.addDays(u).toFormatString("yyyy-MM-dd")),o=u;return n},_updateHotelBox:function(e){if(e){var t,n,r,i=e.length-1;for(var s=0;s<this._hotelCount;s++)n=e[2*s]?e[2*s]:e[i-1],r=e[2*s+1]?e[2*s+1]:e[i],t=5+s*3,this._textboxes[t].value(n),this._textboxes[t+1].value(r),this._textboxes[t+1].data("minDate",n.toDate().addDays(1).toStdDateString())}var o=this.hotelContainer.find("a.move_htl_btn");o[0].className=o.length>1?"move_htl_btn":"move_htl_btn invisible",o.length>=3?$("#FHX_lnkAddHotel").addClass("invisible"):$("#FHX_lnkAddHotel").removeClass("invisible")},addHotel:function(){if(this._hotelCount>=3)return;var e=$.tmpl.render(FHXConfig.hotelTemplate,{to:this.txtTo.value(),toid:this.hToID.value(),count:this._hotelCount}),t=$(S.create(e));t.insertBefore($("#FHX_lnkAddHotel").parentNode()),t.find('input[type="text"]').each(this._regHotelMods.bind(this)),this._updateHotelBox(this._splitFlightDates())},removeHotel:function(e){this._hotelCount--,this._textboxes.splice(e*3+4,3);var t=0;this.hotelContainer.find("li[data-hotel]").each(function(n,r){r==e?n[0].parentNode.removeChild(n[0]):n.find("a").attr("data-index",t++)}),this._updateHotelBox(this._splitFlightDates())},init:function(){if($("#FHX_txtFromDate").length==0)return;e.recover(),Mod.EventEmitter.extend(this),this._initTxts(),this._initMod()},_initMod:function(){this.hotelContainer=$("#FHX_divHotelQuery"),this._initFlightMods(),this._initHotelMods(),this._initPersonSelect(),$("#FHX_btnSearch").bind("click",n.search.bind(n))},_initTxts:function(){this._textboxes.next=function(e){return this[this.indexOf(e)+1]},this._textboxes.last=function(e){return this[this.length-1]}},_initFlightMods:function(){var e=this;["txtFrom","txtTo","txtFromDate","txtToDate"].each(function(t,n){e[t]=$("#FHX_"+t),Mod.regPlaceHolder(e[t],FHXConfig.placeholder[n>1?0:1]),e._textboxes.push(e[t])});var t="http://flights.ctrip.com/international/tools/GetCities.ashx?s=${key}&a=${type}&t="+($.config("charset")=="big5"?"1":"0"),n=/@([a-zA-Z\s]+)/;e.hFromID=$("#FHX_hFromID"),e.hFromPY=$("#FHX_hFromPY"),e.hToID=$("#FHX_hToID"),e.hToPY=$("#FHX_hToPY");var r=e.txtFrom.regMod("address","1.0",{name:"txtFrom",isAutoCorrect:!0,jsonpSource:"http://webresource.c-ctrip.com/ResVacationOnline/R9/js/database/flightintl_start_"+cQuery.config("charset")+".js",jsonpFilter:"http://flights.ctrip.com/international/tools/GetCities.ashx?s=${key}&a=1&t="+($.config("charset")=="big5"?"1":"0"),message:FHXConfig.address.message,template:{suggestion:FHXConfig.address.suggestion[0],suggestionIpad:FHXConfig.address.suggestionIpad[0],suggestionStyle:FHXConfig.address.suggestionStyle,suggestionStyleIpad:FHXConfig.address.suggestionStyle,filter:FHXConfig.address.filter,filterStyle:FHXConfig.address.filterStyle}});r.method("bind","change",function(r,i){e.txtFrom[0].value=i.items[1].replace(/\([^\)]+\)/,""),e.txtFrom[0].blur(),$.jsonp(t.replace("${type}",1).replace("${key}",i.value),{onload:function(t){e.hFromID.value(t.data.split("|")[2]);var r=t.data.match(n)[1];e.hFromPY.value(r)}})}),e.txtFrom.address=r,r=e.txtTo.regMod("address","1.0",{name:"txtTo",isAutoCorrect:!0,jsonpSource:"http://webresource.c-ctrip.com/ResVacationOnline/R9/js/database/flightintl_dest_"+cQuery.config("charset")+".js",jsonpFilter:"http://flights.ctrip.com/international/tools/GetCities.ashx?s=${key}&a=0&t="+($.config("charset")=="big5"?"1":"0"),message:FHXConfig.address.message,template:{suggestion:FHXConfig.address.suggestion[1],suggestionIpad:FHXConfig.address.suggestionIpad[1],suggestionStyle:FHXConfig.address.suggestionStyle,suggestionStyleIpad:FHXConfig.address.suggestionStyle,filter:FHXConfig.address.filter,filterStyle:FHXConfig.address.filterStyle}}),r.method("bind","change",function(r,i){e.txtTo[0].value=i.items[1].replace(/\([^\)]+\)/,""),e.txtTo[0].blur(),$.jsonp(t.replace("${type}",1).replace("${key}",i.value),{onload:function(t){e.hToID.value(t.data.split("|")[2]);var r=t.data.match(n)[1];e.hToPY.value(r),setTimeout(function(){e.emit("tocitychange",e.txtTo.value(),e.hToID.value())},10)}})}),e.txtTo.address=r;var i=e.txtFromDate.regMod("calendar","3.0",{options:{minDate:(new Date).addDays(1).toStdDateString(),showWeek:!1,container:cQuery.container},listeners:{onChange:function(t,n){e.txtToDate.data("startDate",n.toDate().addDays(1).toStdDateString()),e.txtToDate.data("minDate",n.toDate().addDays(1).toStdDateString()),e.txtToDate.data("maxDate",n.toDate().addDays(28).toStdDateString());var r=n.toDate().addDays(-1).toStdDateString();e.emit("fromdatechange",n,r),e.focusNext&&(n>=e.txtToDate.value()&&e.txtToDate.value(n.toDate().addDays(1).toFormatString("yyyy-MM-dd")),e.txtToDate[0].focus())}}});e.txtFromDate.calendar=i,i=e.txtToDate.regMod("calendar","3.0",{options:{minDate:e.txtFromDate.value().toDate().addDays(1).toStdDateString(),maxDate:e.txtFromDate.value().toDate().addDays(28).toStdDateString(),showWeek:!1},listeners:{onChange:function(t,n){var r=n.toDate().addDays(1).toStdDateString();e.emit("todatechange",n,r)}}}),e.txtToDate.calendar=i},_initHotelMods:function(e){var t=this;this.hotelContainer.find('li[data-hotel] input[type="text"]').each(this._regHotelMods.bind(this));if(e)return;this.hotelContainer.bind("click",function(e){if(e.target.nodeName!="A")return;var n=e.target.getAttribute("data-index");switch(e.target.className){case"move_htl_btn":t.removeHotel(+n);break;case"add_htl_btn":t.addHotel()}})},_initPersonSelect:function(){function t(t){var n=Math.min(t*2,9-t);e[1].find("a").each(function(e,t){t>n?e.addClass("hidden"):e.removeClass("hidden")});var r=$("#FHX_ChildrenSelect");r.value()>n&&r.value(0)}var e=[];["AdultSelect","ChildrenSelect"].each(function(n,r){var i=$("#FHX_"+n),s=$("#FHX_"+n+"_Options");e.push(s),i.bind("click",function(t){e.each(function(e,t){t==r?e.removeClass("hidden"):e.addClass("hidden")}),t.stopPropagation()}),s.bind("click",function(e){if(e.target.nodeName!="A")return;var n=+e.target.getAttribute("data-value");i.value(n),s.addClass("hidden"),r==0&&t(n),e.stop()})}),t(+$("#FHX_AdultSelect").value()),$(document).bind("click",function(){e.each(function(e){e.addClass("hidden")})})},_regHotelMods:function(e,t){var n=this,r=t%3;if(r==0){Mod.regPlaceHolder(e,FHXConfig.placeholder[1]);var i=e.parentNode().find('input[type="hidden"]'),s=e.regMod("address","1.0",{name:"cityname",jsonpSource:"http://webresource.c-ctrip.com/ResVacationOnline/R9/js/database/flightintl_dest_"+cQuery.config("charset")+".js",jsonpFilter:"http://vacations.ctrip.com/DIY/Ajax/AjaxGobalCity.aspx?isctrip=1&keyword=${key}",message:FHXConfig.address.message,template:{filter:FHXConfig.address.hotelFilter,filterStyle:FHXConfig.address.hotelFilterStyle,filterPageSize:-1,suggestion:FHXConfig.address.suggestion[1],suggestionIpad:FHXConfig.address.suggestionIpad[1],suggestionStyle:FHXConfig.address.suggestionStyle,suggestionStyleIpad:FHXConfig.address.suggestionStyle},relate:{2:$(i[0]),3:$(i[1])}});s.method("bind","change",function(e,t){n._hotelCityChanged=!0,i[0].value=t.items[2]}),e.address=s,n.on("tocitychange",function(t,r){if(!n._hotelCityChanged){e.value(t);var i=document.getElementsByName("ToCities");for(var s=0;s<i.length;s++)i[s].value=r}}),this._hotelCityChanged=this._hotelCityChanged||e.value()!=n.txtTo.value()}else{Mod.regPlaceHolder(e,FHXConfig.placeholder[0]);if(r==1){var o=e.regMod("calendar","3.0",{options:{minDate:n.txtFromDate.value().toDate().addDays(-1).toStdDateString(),maxDate:n.txtToDate.value().toDate().addDays(1).toStdDateString(),showWeek:!1,container:cQuery.container},listeners:{onChange:function(t,r){n._hotelDateChanged=!0;var i=r.toDate().addDays(1).toStdDateString(),s=n._textboxes.next(e);s.data("startDate",i),s.data("minDate",i),setTimeout(function(){n.focusNext&&(r>=s.value()&&s.value(r.toDate().addDays(1).toFormatString("yyyy-MM-dd")),s[0].focus())},30)}}});n.on("fromdatechange",function(t){n._hotelDateChanged||(e.value(t),n._updateHotelBox(n._splitFlightDates()))})}else{var o=e.regMod("calendar","3.0",{options:{minDate:(n._textboxes.last().value()||n.txtFromDate.value()).toDate().addDays(1).toStdDateString(),maxDate:n.txtToDate.value().toDate().addDays(1).toStdDateString(),showWeek:!1},listeners:{onChange:function(e,t){n._hotelDateChanged=!0}}});n._hotelCount++,n.on("todatechange",function(e){n._hotelDateChanged||n._updateHotelBox(n._splitFlightDates())})}e.calendar=o,n.on("fromdatechange",function(t,n){e.data("minDate",n)}),n.on("todatechange",function(t,n){e.data("maxDate",n)})}n._textboxes.push(e)}};FHX={init:function(){$.mod.load("address","1.0"),$.mod.load("calendar","3.0"),$.mod.load("validate","1.1"),n.init()}},FHX.init()})()